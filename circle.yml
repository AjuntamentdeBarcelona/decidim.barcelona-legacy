machine:
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
    - .bundle
    - public/assets
  override:
    - if [[ -e ~/docker/image.tar ]]; then docker load -i ~/docker/image.tar; fi
    - sudo pip install --upgrade docker-compose==1.5.2
    - docker pull ultrayoshi/ruby-node-phantomjs:2.1.1
    - docker pull postgres
    - docker pull redis
    - docker-compose build
    - docker-compose run app bundle install
    - mkdir -p ~/docker; docker save ultrayoshi/ruby-node-phantomjs:2.1.1 postgres redis > ~/docker/image.tar
    - docker-compose run app rake db:setup
    - docker-compose run -e RAILS_ENV=test app bundle exec rake assets:precompile

database:
  override:
    - echo 'done'

test:
  override:
    - docker-compose run -e CI=$CI -e CIRCLECI=$CIRCLECI -e CI_PULL_REQUEST=$CI_PULL_REQUEST -e CIRCLE_NODE_TOTAL=$CIRCLE_NODE_TOTAL -e CIRCLE_NODE_INDEX=$CIRCLE_NODE_INDEX -e COVERALLS_REPO_TOKEN=$COVERALLS_REPO_TOKEN -e CIRCLE_BUILD_NUM=$CIRCLE_BUILD_NUM -e CIRCLE_BRANCH=$CIRCLE_BRANCH -e CIRCLE_SHA1=$CIRCLE_SHA1 app bundle exec rspec:
